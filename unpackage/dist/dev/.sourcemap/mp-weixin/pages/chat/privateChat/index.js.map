{"version":3,"sources":["uni-app:///main.js","webpack:///C:/Users/dell/Desktop/QINGHELI-Employee/pages/chat/privateChat/index.vue?7694","webpack:///C:/Users/dell/Desktop/QINGHELI-Employee/pages/chat/privateChat/index.vue?239a","webpack:///C:/Users/dell/Desktop/QINGHELI-Employee/pages/chat/privateChat/index.vue?6659","webpack:///C:/Users/dell/Desktop/QINGHELI-Employee/pages/chat/privateChat/index.vue?961f","uni-app:///pages/chat/privateChat/index.vue"],"names":["createPage","Page"],"mappings":";;;;;;;;;;kDAAA;AACA;AACA,wG;AACAA,UAAU,CAACC,cAAD,CAAV,C;;;;;;;;;;;;;ACHA;AAAA;AAAA;AAAA;AAAA;AAAkH;AAClH;AACyD;AACL;;;AAGpD;AACqK;AACrK,gBAAgB,+KAAU;AAC1B,EAAE,2EAAM;AACR,EAAE,gFAAM;AACR,EAAE,yFAAe;AACjB;AACA;AACA;AACA;AACA;AACA,EAAE,oFAAU;AACZ;AACA;;AAEA;AACe,gF;;;;;;;;;;;;ACtBf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA,WAAW,8OAEN;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;AClCA;AAAA;AAAA;AAAA;AAA+lB,CAAgB,ynBAAG,EAAC,C;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACwFnnB,yG;AACA,+C;;AAEA;AACA,qBADA;AAEA;AACA,wCADA,EAFA;;AAKA,MALA,kBAKA;AACA;AACA;AACA,+BADA;AAEA,8BAFA;AAGA,8BAHA;AAIA,8BAJA;AAKA,8BALA;AAMA,8BANA;;;AASA;AACA;AACA,iBAFA;AAGA;AACA,gBAJA;;;AAOA,uBAPA;AAQA;AACA,kBATA;AAUA;AACA,6BAXA;;AAaA;AACA;AACA,qBADA;AAEA,qBAFA;AAGA,mBAHA;AAIA,8DAJA,EAdA;;AAoBA;AACA,mBADA,EApBA;;AAuBA;AACA;AACA,wBAFA;AAGA;AACA,sBAJA,EAvBA;;AA6BA;AACA,sBADA;AAEA,eAFA;AAGA,qBAHA,EA7BA;;AAkCA,qBAlCA;AAmCA,cAnCA;;AAqCA,GArDA;AAsDA,SAtDA,qBAsDA;AACA;AACA,GAxDA;AAyDA,QAzDA,oBAyDA;AACA;AACA;AACA,GA5DA;AA6DA,QA7DA,kBA6DA,OA7DA,EA6DA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,iCADA;;;AAIA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,KARA;;;AAWA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;;AAGA,GA7GA;AA8GA;AACA;AACA,GAhHA;AAiHA,UAjHA,sBAiHA;AACA;AACA;AACA;AACA;AACA,GAtHA;AAuHA;;AAEA;AACA;AACA,qBAJA,6BAIA,OAJA,EAIA;AACA;AACA;AACA;AACA;AACA,KATA;;AAWA;AACA;AACA,qBAbA,6BAaA,OAbA,EAaA,KAbA,EAaA;AACA;AACA;AACA,OAFA,MAEA;AACA;AACA;AACA;AACA;AACA;AACA,KAtBA;;;AAyBA,yBAzBA,mCAyBA;AACA;AACA;AACA;AACA,OAFA;;AAIA;AACA;AACA;AACA;AACA;AACA,gCADA;AAEA,+CAFA;AAGA;AACA,sCADA;AAEA,0CAFA,EAHA,EADA;;;AASA,mBATA;AAUA;AACA;AACA,WAZA;AAaA;AACA,qDADA;AAEA,0BAFA,CAEA;AAFA,WAbA;;AAkBA;AACA,OArBA;;AAuBA;AACA;AACA;AACA,OAFA;AAGA,KA3DA;AA4DA,mBA5DA,6BA4DA;AACA;AACA;AACA;AACA;AACA,4BADA,EACA;AACA;AACA,8BADA;AAEA,6CAFA;AAGA;AACA,wCADA;AAEA,wCAFA,EAHA,EAFA;;;AAUA;AACA,mDADA;AAEA,sBAFA,CAEA;AAFA,WAVA;;AAeA;AACA;AACA;AACA;AACA,KAnFA;AAoFA,0BApFA,oCAoFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OANA,EAMA,KANA,CAMA;AACA;AACA;AACA,OATA;AAUA,KAtGA;AAuGA;AACA,uBAxGA,iCAwGA;AACA;AACA;AACA;AACA,+BADA;;AAGA;AACA,KA/GA;AAgHA,iBAhHA,2BAgHA;AACA;AACA;AACA,OAFA,CAEA;AACA;AACA,uBADA;AAEA,+EAFA;;AAIA;AACA,KAzHA;AA0HA,eA1HA,yBA0HA;AACA;AACA;AACA,OAFA,CAEA;AACA;AACA;AACA,KAhIA;AAiIA,aAjIA,uBAiIA;AACA;AACA;AACA;AACA;AACA,kCADA;AAEA,iDAFA;AAGA;AACA,wCADA;AAEA,4CAFA,EAHA,EADA;;;AASA,qBATA;AAUA;AACA;AACA,aAZA;AAaA;AACA,uDADA;AAEA,4BAFA,CAEA;AAFA,aAbA;;AAkBA;AACA,SArBA;;AAuBA,KAzJA;AA0JA,aA1JA,uBA0JA;AACA;AACA,gBADA;AAEA;AACA;AACA;AACA,kCADA;AAEA,iDAFA;AAGA;AACA,wCADA;AAEA,4CAFA,EAHA,EADA;;;AASA,qBATA;AAUA;AACA;AACA,aAZA;AAaA;AACA,uDADA;AAEA,4BAFA,CAEA;AAFA,aAbA;;AAkBA;AACA,SAtBA;;AAwBA,KAnLA;AAoLA,uBApLA,+BAoLA,CApLA,EAoLA;AACA;AACA;AACA,uBADA;;AAGA,KAzLA;AA0LA,aA1LA,qBA0LA,CA1LA,EA0LA;AACA;AACA;AACA,KA7LA;AA8LA,oBA9LA,8BA8LA;AACA;AACA,oBADA;;AAGA,KAlMA;AAmMA,2BAnMA,mCAmMA,CAnMA,EAmMA;AACA;AACA;AACA;AACA;AACA;AACA,KAzMA;AA0MA,uBA1MA,iCA0MA;AACA;AACA;AACA,KA7MA;AA8MA,aA9MA,uBA8MA;AACA;AACA;AACA,KAjNA;AAkNA,YAlNA,sBAkNA;AACA;AACA;AACA,KArNA;AAsNA,eAtNA,uBAsNA,QAtNA,EAsNA;AACA;AACA,KAxNA;AAyNA,yBAzNA,mCAyNA;AACA;AACA,0BADA;AAEA,8BAFA;AAGA,kCAHA;AAIA,yCAJA;;AAMA;AACA,sEADA;;AAGA,KAnOA;AAoOA,kBApOA,4BAoOA;AACA;AACA;AACA,4BADA;AAEA,sBAFA;;AAIA,OALA;AAMA,KA3OA;AA4OA,4BA5OA,oCA4OA,QA5OA,EA4OA;AACA;AACA,UADA,CACA;AACA;AACA,OAHA;AAIA,WAJA,CAIA;AACA;AACA,OANA;AAOA,KApPA,EAvHA,E","file":"pages/chat/privateChat/index.js","sourcesContent":["import 'uni-pages';\nimport Vue from 'vue'\nimport Page from './pages/chat/privateChat/index.vue'\ncreatePage(Page)","import { render, staticRenderFns, recyclableRender, components } from \"./index.vue?vue&type=template&id=cbe8c300&\"\nvar renderjs\nimport script from \"./index.vue?vue&type=script&lang=js&\"\nexport * from \"./index.vue?vue&type=script&lang=js&\"\n\n\n/* normalize component */\nimport normalizer from \"!D:\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\vue-loader\\\\lib\\\\runtime\\\\componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  null,\n  null,\n  false,\n  components,\n  renderjs\n)\n\ncomponent.options.__file = \"pages/chat/privateChat/index.vue\"\nexport default component.exports","export * from \"-!D:\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\vue-loader\\\\lib\\\\loaders\\\\templateLoader.js??vue-loader-options!D:\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\webpack-preprocess-loader\\\\index.js??ref--16-0!D:\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\webpack-uni-mp-loader\\\\lib\\\\template.js!D:\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\webpack-uni-app-loader\\\\page-meta.js!D:\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\vue-loader\\\\lib\\\\index.js??vue-loader-options!D:\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\webpack-uni-mp-loader\\\\lib\\\\style.js!./index.vue?vue&type=template&id=cbe8c300&\"","var components = {\n  GoEasyAudioPlayer: function() {\n    return import(\n      /* webpackChunkName: \"components/GoEasyAudioPlayer/GoEasyAudioPlayer\" */ \"@/components/GoEasyAudioPlayer/GoEasyAudioPlayer.vue\"\n    )\n  }\n}\nvar render = function() {\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n  var l0 = _vm.__map(_vm.messages, function(message, index) {\n    var $orig = _vm.__get_orig(message)\n\n    var m0 = _vm.renderMessageDate(message, index)\n    var m1 = _vm.renderTextMessage(message)\n    return {\n      $orig: $orig,\n      m0: m0,\n      m1: m1\n    }\n  })\n\n  _vm.$mp.data = Object.assign(\n    {},\n    {\n      $root: {\n        l0: l0\n      }\n    }\n  )\n}\nvar recyclableRender = false\nvar staticRenderFns = []\nrender._withStripped = true\n\nexport { render, staticRenderFns, recyclableRender, components }","import mod from \"-!D:\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\babel-loader\\\\lib\\\\index.js!D:\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\webpack-preprocess-loader\\\\index.js??ref--12-1!D:\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\webpack-uni-mp-loader\\\\lib\\\\script.js!D:\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\vue-loader\\\\lib\\\\index.js??vue-loader-options!D:\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\webpack-uni-mp-loader\\\\lib\\\\style.js!./index.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!D:\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\babel-loader\\\\lib\\\\index.js!D:\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\webpack-preprocess-loader\\\\index.js??ref--12-1!D:\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\webpack-uni-mp-loader\\\\lib\\\\script.js!D:\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\vue-cli-plugin-uni\\\\packages\\\\vue-loader\\\\lib\\\\index.js??vue-loader-options!D:\\\\HBuilderX\\\\plugins\\\\uniapp-cli\\\\node_modules\\\\@dcloudio\\\\webpack-uni-mp-loader\\\\lib\\\\style.js!./index.vue?vue&type=script&lang=js&\"","<template>\r\n\t<view class=\"chatInterface\">\r\n\t\t<view class=\"scroll-view\">\r\n\t\t\t<view class=\"all-history-loaded\">\r\n\t\t\t\t{{allHistoryLoaded ? '已经没有更多的历史消息' : '下拉获取历史消息'}}\r\n\t\t\t</view>\r\n\t\t\t<!--已经收到的消息-->\r\n\t\t\t<view v-for=\"(message,index) in messages\" :key=\"message.messageId\">\r\n\r\n\t\t\t\t<!-- 时间显示，类似于微信，隔5分钟不发言，才显示时间-->\r\n\t\t\t\t<view class=\"time-lag\">\r\n\t\t\t\t\t{{renderMessageDate(message, index)}}\r\n\t\t\t\t</view>\r\n\r\n\t\t\t\t<view class=\"message-item\" :class=\"{'self' : message.senderId == (currentUser && currentUser.id)}\">\r\n\t\t\t\t\t<view class=\"avatar\" v-if=\"message.senderId != (currentUser && currentUser.id)\">\r\n\t\t\t\t\t\t<image :src=\"friend.avatar\"></image>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t\t<view class=\"avatar\" v-else>\r\n\t\t\t\t\t\t<image :src=\"currentUser.avatar\"></image>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t\t<view class=\"content\">\r\n\t\t\t\t\t\t<b class=\"pending\" v-if=\"message.status == 'sending'\"></b>\r\n\t\t\t\t\t\t<b class=\"send-fail\" v-if=\"message.status == 'fail'\"></b>\r\n\t\t\t\t\t\t<view v-html=\"renderTextMessage(message)\"></view>\r\n\t\t\t\t\t\t<image class=\"image-content\" v-if=\"message.type == 'image'\" :src=\"message.payload.url\" :data-url=\"message.payload.url\"\r\n\t\t\t\t\t\t @click=\"showImageFullScreen\" mode=\"widthFix\"></image>\r\n\t\t\t\t\t\t<view class=\"video-snapshot\" v-if=\"message.type == 'video'\" :data-url=\"message.payload.video.url\" @click=\"playVideo\">\r\n\t\t\t\t\t\t\t<image :src=\"message.payload.thumbnail.url\" mode=\"aspectFit\"></image>\r\n\t\t\t\t\t\t\t<view class=\"video-play-icon\"></view>\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t<GoEasyAudioPlayer v-if=\"message.type =='audio'\" :src=\"message.payload.url\" :duration=\"message.payload.duration\" />\r\n\t\t\t\t\t\t<view class=\"custom-message\" v-if=\"message.type == 'order'\">\r\n\t\t\t\t\t\t\t<view class=\"title\">\r\n\t\t\t\t\t\t\t\t<image src=\"/static/images/chat/dingdan.png\"></image>\r\n\t\t\t\t\t\t\t\t<text>自定义消息</text>\r\n\t\t\t\t\t\t\t</view>\r\n\t\t\t\t\t\t\t<view class=\"custom-message-item\">编号: {{message.payload.number}}</view>\r\n\t\t\t\t\t\t\t<view class=\"custom-message-item\">商品: {{message.payload.goods}}</view>\r\n\t\t\t\t\t\t\t<view class=\"custom-message-item\">金额: {{message.payload.price}}</view>\r\n\t\t\t\t\t\t</view>\r\n\t\t\t\t\t</view>\r\n\t\t\t\t</view>\r\n\t\t\t</view>\r\n\t\t</view>\r\n\t\t<!-- 输入框 -->\r\n\t\t<view class=\"action-box\" v-if=\"!video.visible\">\r\n\t\t\t<view class=\"action-top\">\r\n\t\t\t\t<view :class=\"[audio.visible ? 'record-icon record-open':'record-icon']\" @click=\"switchAudioKeyboard\"></view>\r\n\t\t\t\t<view class=\"record-input\" @touchstart=\"onRecordStart\" @touchend=\"onRecordEnd\" v-if=\"audio.visible\">{{audio.recording ? '松开发送' : '按住录音'}}</view>\r\n\t\t\t\t<view class=\"message-input\" v-else>\r\n\t\t\t\t\t<!-- GoEasyIM最大支持3k的文本消息，如需发送长文本，需调整输入框maxlength值 -->\r\n\t\t\t\t\t<input type=\"text\" maxlength=\"700\" placeholder=\"发送消息\" v-model=\"content\" @focus=\"messageInputFocusin\">\r\n\t\t\t\t</view>\r\n\t\t\t\t<view class=\"file-icon emoji-icon\" @click=\"showEmoji\"></view>\r\n\t\t\t\t<view class=\"file-icon more-icon\" @click=\"showMore\"></view>\r\n\t\t\t\t<span class=\"send-message-btn\" @click=\"sendTextMessage\">发送</span>\r\n\t\t\t</view>\r\n\r\n\t\t\t<!--展示表情列表-->\r\n\t\t\t<view class=\"action-bottom\" v-if=\"emoji.show\" style=\"justify-content: space-around\">\r\n\t\t\t\t<image class=\"emoji-item\" v-for=\"(emojiItem, emojiKey, index) in emoji.map\" :key=\"index\" :src=\"emoji.url + emojiItem\"\r\n\t\t\t\t @click=\"selectEmoji(emojiKey)\"></image>\r\n\t\t\t</view>\r\n\t\t\t<!--更多-->\r\n\t\t\t<view class=\"action-bottom\" v-if=\"more.show\">\r\n\t\t\t\t<view class=\"more-item\" @click=\"sendImage\">\r\n\t\t\t\t\t<image src=\"/static/images/chat/tupian.png\"></image>\r\n\t\t\t\t\t<text>图片</text>\r\n\t\t\t\t</view>\r\n\t\t\t\t<view class=\"more-item\" @click=\"sendVideo\">\r\n\t\t\t\t\t<image src=\"/static/images/chat/shipin.png\"></image>\r\n\t\t\t\t\t<text>视频</text>\r\n\t\t\t\t</view>\r\n\t\t\t\t<view class=\"more-item\" @click=\"showCustomMessageForm\">\r\n\t\t\t\t\t<image src=\"/static/images/chat/zidingyi.png\"></image>\r\n\t\t\t\t\t<text>自定义消息</text>\r\n\t\t\t\t</view>\r\n\t\t\t</view>\r\n\t\t</view>\r\n\t\t<view class=\"record-loading\" v-if=\"audio.recording\"></view>\r\n\t\t<video :src=\"video.url\" v-if=\"video.visible\" id=\"videoPlayer\" autoplay=\"true\" @fullscreenchange=\"onVideoFullScreenChange\"\r\n\t\t @play=\"onVideoPlayStart\"></video>\r\n\t</view>\r\n</template>\r\n\r\n<script>\r\n\timport GoEasyAudioPlayer from \"../../../components/GoEasyAudioPlayer/GoEasyAudioPlayer.vue\";\r\n\timport EmojiDecoder from \"../../../lib/EmojiDecoder.js\";\r\n\tconst recorderManager = uni.getRecorderManager();\r\n\r\n\texport default {\r\n\t\tname: \"privateChat\",\r\n\t\tcomponents: {\r\n\t\t\tGoEasyAudioPlayer,\r\n\t\t},\r\n\t\tdata() {\r\n\t\t\tlet emojiUrl = 'https://imgcache.qq.com/open/qcloud/tim/assets/emoji/';\r\n\t\t\tlet emojiMap = {\r\n\t\t\t\t'[么么哒]': 'emoji_3@2x.png',\r\n\t\t\t\t'[乒乓]': 'emoji_4@2x.png',\r\n\t\t\t\t'[便便]': 'emoji_5@2x.png',\r\n\t\t\t\t'[信封]': 'emoji_6@2x.png',\r\n\t\t\t\t'[偷笑]': 'emoji_7@2x.png',\r\n\t\t\t\t'[傲慢]': 'emoji_8@2x.png'\r\n\t\t\t};\r\n\r\n\t\t\treturn {\r\n\t\t\t\t//聊天文本框\r\n\t\t\t\tcontent: '',\r\n\t\t\t\t// 企业用户信息\r\n\t\t\t\tfriend: {\r\n\r\n\t\t\t\t},\r\n\t\t\t\tcurrentUser: null,\r\n\t\t\t\t//已经接收到的消息\r\n\t\t\t\tmessages: [],\r\n\t\t\t\t//已经加载完所有历史消息\r\n\t\t\t\tallHistoryLoaded: false,\r\n\r\n\t\t\t\t//定义表情列表\r\n\t\t\t\temoji: {\r\n\t\t\t\t\turl: emojiUrl,\r\n\t\t\t\t\tmap: emojiMap,\r\n\t\t\t\t\tshow: false,\r\n\t\t\t\t\tdecoder: new EmojiDecoder(emojiUrl, emojiMap),\r\n\t\t\t\t},\r\n\t\t\t\tmore: { //更多按钮\r\n\t\t\t\t\tshow: false\r\n\t\t\t\t},\r\n\t\t\t\taudio: {\r\n\t\t\t\t\t//语音录音中\r\n\t\t\t\t\trecording: false,\r\n\t\t\t\t\t//录音按钮展示\r\n\t\t\t\t\tvisible: false\r\n\t\t\t\t},\r\n\t\t\t\tvideo: {\r\n\t\t\t\t\tvisible: false,\r\n\t\t\t\t\turl: '',\r\n\t\t\t\t\tcontext: null\r\n\t\t\t\t},\r\n\t\t\t\timService: null,\r\n\t\t\t\tinfo: {}\r\n\t\t\t}\r\n\t\t},\r\n\t\tonReady() {\r\n\t\t\tthis.video.context = uni.createVideoContext('videoPlayer');\r\n\t\t},\r\n\t\tonShow() {\r\n\t\t\tthis.more.show = false;\r\n\t\t\tthis.emoji.show = false;\r\n\t\t},\r\n\t\tonLoad(options) {\r\n\t\t\tthis.imService = getApp().globalData.imService;\r\n\t\t\tthis.currentUser = uni.getStorageSync('currentUser');\r\n\r\n\t\t\t//对话数据\r\n\t\t\tlet info = JSON.parse(options.info)\r\n\t\t\tconsole.log(info);\r\n\t\t\tlet friendId = info.publisher.id;\r\n\t\t\tthis.friend = info.publisher;\r\n\t\t\tthis.info = info\r\n\t\t\t//从服务器获取最新的好友信息\r\n\t\t\t// {\r\n\t\t\t//     \"id\": \"1\",\r\n\t\t\t//     \"name\": \"Mattie\",\r\n\t\t\t//     \"password\": \"123\",\r\n\t\t\t//     \"avatar\": '/static/images/Avatar-1.png'\r\n\t\t\t// }\r\n\t\t\t// this.friend = this.imService.findFriendById(friendId);\r\n\r\n\t\t\tthis.messages = this.imService.getPrivateMessages(friendId);\r\n\t\t\tuni.setNavigationBarTitle({\r\n\t\t\t\ttitle: this.friend.nickName\r\n\t\t\t});\r\n\r\n\t\t\t//监听新消息\r\n\t\t\tthis.imService.onNewPrivateMessageReceive = (friendId, message) => {\r\n\t\t\t\tif (friendId == this.friend.id) {\r\n\r\n\t\t\t\t\t//聊天时，收到消息标记为已读\r\n\t\t\t\t\tthis.markPrivateMessageAsRead(friendId);\r\n\t\t\t\t\t//收到新消息，是滚动到最底部\r\n\t\t\t\t\tthis.scrollToBottom()\r\n\t\t\t\t}\r\n\t\t\t};\r\n\r\n\r\n\t\t\t//每次进入聊天页面，总是滚动到底部\r\n\t\t\tthis.scrollToBottom();\r\n\r\n\t\t\t// 录音监听器\r\n\t\t\tthis.initRecorderListeners();\r\n\r\n\t\t\t//收到的消息设置为已读\r\n\t\t\tif (this.messages.length != 0) {\r\n\t\t\t\tthis.markPrivateMessageAsRead(friendId);\r\n\t\t\t}\r\n\r\n\r\n\t\t},\r\n\t\tonPullDownRefresh: function(e) {\r\n\t\t\tthis.loadMoreHistoryMessage();\r\n\t\t},\r\n\t\tonUnload() {\r\n\t\t\t//退出聊天页面之前，清空页面传入的监听器\r\n\t\t\tif (this.imService) {\r\n\t\t\t\tthis.imService.onNewPrivateMessageReceive = (friendId, message) => {};\r\n\t\t\t}\r\n\t\t},\r\n\t\tmethods: {\r\n\r\n\t\t\t//渲染文本消息，如果包含表情，替换为图片\r\n\t\t\t//todo:本不需要该方法，可以在标签里完成，但小程序有兼容性问题，被迫这样实现\r\n\t\t\trenderTextMessage(message) {\r\n\t\t\t\tif (message.type === 'text') {\r\n\t\t\t\t\treturn '<span class=\"text-content\">' + this.emoji.decoder.decode(message.payload.text) + '</span>'\r\n\t\t\t\t}\r\n\t\t\t\treturn ''\r\n\t\t\t},\r\n\r\n\t\t\t//像微信那样显示时间，如果有几分钟没发消息了，才显示时间\r\n\t\t\t//todo:本不需要该方法，可以在标签里完成，但小程序有兼容性问题，被迫这样实现\r\n\t\t\trenderMessageDate(message, index) {\r\n\t\t\t\tif (index === 0) {\r\n\t\t\t\t\treturn this.formatDate(message.timestamp)\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (message.timestamp - this.messages[index - 1].timestamp > 5 * 60 * 1000) {\r\n\t\t\t\t\t\treturn this.formatDate(message.timestamp)\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn ''\r\n\t\t\t},\r\n\r\n\r\n\t\t\tinitRecorderListeners() {\r\n\t\t\t\t// 监听录音开始\r\n\t\t\t\trecorderManager.onStart(() => {\r\n\t\t\t\t\tthis.audio.recording = true;\r\n\t\t\t\t});\r\n\r\n\t\t\t\t//录音结束后，发送\r\n\t\t\t\trecorderManager.onStop((res) => {\r\n\t\t\t\t\tthis.audio.recording = false;\r\n\t\t\t\t\tlet audioMessage = this.im.createAudioMessage({\r\n\t\t\t\t\t\tto: {\r\n\t\t\t\t\t\t\tid: this.friend.id,\r\n\t\t\t\t\t\t\ttype: this.GoEasyIM.SCENE.PRIVATE,\r\n\t\t\t\t\t\t\tdata: {\r\n\t\t\t\t\t\t\t\tname: this.friend.name,\r\n\t\t\t\t\t\t\t\tavatar: this.friend.avatar\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tfile: res,\r\n\t\t\t\t\t\tonProgress: function(progress) {\r\n\t\t\t\t\t\t\tconsole.log(progress)\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tnotification: {\r\n\t\t\t\t\t\t\ttitle: this.currentUser.name + '发来一段语音',\r\n\t\t\t\t\t\t\tbody: '[语音消息]' // 字段最长 50 字符\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tthis.imService.sendMessage(audioMessage)\r\n\t\t\t\t});\r\n\r\n\t\t\t\t// 监听录音报错\r\n\t\t\t\trecorderManager.onError(function(res) {\r\n\t\t\t\t\tconsole.log(\"录音报错：\", res);\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\tsendTextMessage() { //发送消息\r\n\t\t\t\t//创建消息, 内容最长不超过3K，可以发送字符串，对象和json格式字符串\r\n\t\t\t\tif (this.content.trim() != '') {\r\n\t\t\t\t\tlet body = this.content;\r\n\t\t\t\t\tlet textMessage = this.im.createTextMessage({\r\n\t\t\t\t\t\ttext: this.content, //消息内容\r\n\t\t\t\t\t\tto: {\r\n\t\t\t\t\t\t\tid: this.friend.id,\r\n\t\t\t\t\t\t\ttype: this.GoEasyIM.SCENE.PRIVATE,\r\n\t\t\t\t\t\t\tdata: {\r\n\t\t\t\t\t\t\t\tname: this.friend.nickName,\r\n\t\t\t\t\t\t\t\tavatar: this.friend.avatar,\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tnotification: {\r\n\t\t\t\t\t\t\ttitle: this.currentUser.name + '发来一段文字',\r\n\t\t\t\t\t\t\tbody: body // 字段最长 50 字符\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tthis.imService.sendMessage(textMessage);\r\n\t\t\t\t}\r\n\t\t\t\tthis.scrollToBottom();\r\n\t\t\t\tthis.content = \"\";\r\n\t\t\t},\r\n\t\t\tloadMoreHistoryMessage() { //历史消息\r\n\t\t\t\tlet lastMessageTimeStamp = Date.now();\r\n\t\t\t\tlet lastMessage = this.messages[0];\r\n\t\t\t\tif (lastMessage) {\r\n\t\t\t\t\tlastMessageTimeStamp = lastMessage.timestamp;\r\n\t\t\t\t}\r\n\t\t\t\tlet currentLength = this.messages.length;\r\n\t\t\t\tlet promise = this.imService.loadPrivateHistoryMessage(this.friend.id, lastMessageTimeStamp);\r\n\t\t\t\tpromise.then(messages => {\r\n\t\t\t\t\tif (messages.length == currentLength) {\r\n\t\t\t\t\t\tthis.allHistoryLoaded = true\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.messages = messages;\r\n\t\t\t\t\tuni.stopPullDownRefresh();\r\n\t\t\t\t}).catch(e => {\r\n\t\t\t\t\tconsole.log(e)\r\n\t\t\t\t\tuni.stopPullDownRefresh();\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\t//语音录制按钮和键盘输入的切换\r\n\t\t\tswitchAudioKeyboard() {\r\n\t\t\t\tthis.audio.visible = !this.audio.visible;\r\n\t\t\t\tif (uni.authorize) {\r\n\t\t\t\t\tuni.authorize({\r\n\t\t\t\t\t\tscope: 'scope.record'\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tonRecordStart() {\r\n\t\t\t\ttry {\r\n\t\t\t\t\trecorderManager.start();\r\n\t\t\t\t} catch (e) {\r\n\t\t\t\t\tuni.showModal({\r\n\t\t\t\t\t\ttitle: '录音错误',\r\n\t\t\t\t\t\tcontent: '请在app和小程序端体验录音，Uni官方明确H5不支持getRecorderManager, 详情查看Uni官方文档'\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tonRecordEnd() {\r\n\t\t\t\ttry {\r\n\t\t\t\t\trecorderManager.stop();\r\n\t\t\t\t} catch (e) {\r\n\t\t\t\t\tconsole.log(e)\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tsendVideo() { //发送文件\r\n\t\t\t\tuni.chooseVideo({\r\n\t\t\t\t\tsuccess: (res) => {\r\n\t\t\t\t\t\tlet videoMessage = this.im.createVideoMessage({\r\n\t\t\t\t\t\t\tto: {\r\n\t\t\t\t\t\t\t\tid: this.friend.id,\r\n\t\t\t\t\t\t\t\ttype: this.GoEasyIM.SCENE.PRIVATE,\r\n\t\t\t\t\t\t\t\tdata: {\r\n\t\t\t\t\t\t\t\t\tname: this.friend.name,\r\n\t\t\t\t\t\t\t\t\tavatar: this.friend.avatar\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tfile: res,\r\n\t\t\t\t\t\t\tonProgress: function(progress) {\r\n\t\t\t\t\t\t\t\tconsole.log(progress)\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tnotification: {\r\n\t\t\t\t\t\t\t\ttitle: this.currentUser.name + '发来一个视频',\r\n\t\t\t\t\t\t\t\tbody: '[视频消息]' // 字段最长 50 字符\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tthis.imService.sendMessage(videoMessage)\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\tsendImage() {\r\n\t\t\t\tuni.chooseImage({\r\n\t\t\t\t\tcount: 1,\r\n\t\t\t\t\tsuccess: (res) => {\r\n\t\t\t\t\t\tlet imageMessage = this.im.createImageMessage({\r\n\t\t\t\t\t\t\tto: {\r\n\t\t\t\t\t\t\t\tid: this.friend.id,\r\n\t\t\t\t\t\t\t\ttype: this.GoEasyIM.SCENE.PRIVATE,\r\n\t\t\t\t\t\t\t\tdata: {\r\n\t\t\t\t\t\t\t\t\tname: this.friend.name,\r\n\t\t\t\t\t\t\t\t\tavatar: this.friend.avatar\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tfile: res,\r\n\t\t\t\t\t\t\tonProgress: function(progress) {\r\n\t\t\t\t\t\t\t\tconsole.log(progress)\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tnotification: {\r\n\t\t\t\t\t\t\t\ttitle: this.currentUser.name + '发来一张图片',\r\n\t\t\t\t\t\t\t\tbody: '[图片消息]' // 字段最长 50 字符\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tthis.imService.sendMessage(imageMessage);\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\tshowImageFullScreen(e) {\r\n\t\t\t\tvar imagesUrl = [e.currentTarget.dataset.url];\r\n\t\t\t\tuni.previewImage({\r\n\t\t\t\t\turls: imagesUrl\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\tplayVideo(e) {\r\n\t\t\t\tthis.video.visible = true;\r\n\t\t\t\tthis.video.url = e.currentTarget.dataset.url;\r\n\t\t\t},\r\n\t\t\tonVideoPlayStart() {\r\n\t\t\t\tthis.video.context.requestFullScreen({\r\n\t\t\t\t\tdirection: 0\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t\tonVideoFullScreenChange(e) {\r\n\t\t\t\t//当退出全屏播放时，隐藏播放器\r\n\t\t\t\tif (this.video.visible && !e.detail.fullScreen) {\r\n\t\t\t\t\tthis.video.visible = false;\r\n\t\t\t\t\tthis.video.context.stop();\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tmessageInputFocusin() {\r\n\t\t\t\tthis.more.show = false;\r\n\t\t\t\tthis.emoji.show = false\r\n\t\t\t},\r\n\t\t\tshowEmoji() {\r\n\t\t\t\tthis.emoji.show = !this.emoji.show;\r\n\t\t\t\tthis.more.show = false;\r\n\t\t\t},\r\n\t\t\tshowMore() {\r\n\t\t\t\tthis.more.show = !this.more.show;\r\n\t\t\t\tthis.emoji.show = false\r\n\t\t\t},\r\n\t\t\tselectEmoji(emojiKey) {\r\n\t\t\t\tthis.content += emojiKey\r\n\t\t\t},\r\n\t\t\tshowCustomMessageForm() {\r\n\t\t\t\tlet to = {\r\n\t\t\t\t\tid: this.friend.id,\r\n\t\t\t\t\tname: this.friend.name,\r\n\t\t\t\t\tavatar: this.friend.avatar,\r\n\t\t\t\t\ttype: this.GoEasyIM.SCENE.PRIVATE\r\n\t\t\t\t};\r\n\t\t\t\tuni.navigateTo({\r\n\t\t\t\t\turl: '../customMessage/customMessage?to=' + JSON.stringify(to)\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\tscrollToBottom() {\r\n\t\t\t\tthis.$nextTick(function() {\r\n\t\t\t\t\tuni.pageScrollTo({\r\n\t\t\t\t\t\tscrollTop: 2000000,\r\n\t\t\t\t\t\tduration: 10\r\n\t\t\t\t\t})\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\tmarkPrivateMessageAsRead(friendId) {\r\n\t\t\t\tthis.im.markPrivateMessageAsRead(friendId)\r\n\t\t\t\t\t.then(() => {\r\n\t\t\t\t\t\tconsole.log('标记为已读成功')\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.catch(e => {\r\n\t\t\t\t\t\tconsole.log(e)\r\n\t\t\t\t\t})\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n</script>\r\n\r\n<style>\r\n</style>\n"],"sourceRoot":""}